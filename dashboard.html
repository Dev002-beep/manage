<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>إحصائيات تفعيل الشهور | AMG</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        :root {
            --primary-color: #6C5CE7;
            --secondary-color: #A29BFE;
            --light-color: #F5F6FA;
            --dark-color: #2D3436;
        }
        body {
            font-family: 'Tajawal', sans-serif;
            background-color: var(--light-color);
            margin: 0;
            padding: 0;
            color: var(--dark-color);
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        header {
            background-color: var(--primary-color);
            color: white;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: 0 0 15px 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .back-btn {
            background: rgba(255,255,255,0.2);
            padding: 8px 15px;
            border-radius: 5px;
            color: white;
            text-decoration: none;
            font-weight: bold;
            transition: 0.3s;
        }
        .back-btn:hover { background: rgba(255,255,255,0.3); }
        
        .filters {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: flex-end;
        }
        .filter-group {
            flex: 1;
            min-width: 200px;
        }
        .filter-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }
        .filter-group input, .filter-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        .action-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            color: white;
            background-color: var(--primary-color);
            transition: 0.3s;
        }
        .action-btn:hover { opacity: 0.9; }
        .pdf-btn { background-color: #E74C3C; }
        
        .stats-cards {
            display: flex;
            gap: 20px;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        .card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            flex: 1;
            min-width: 200px;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            border-top: 4px solid var(--primary-color);
        }
        .card h3 { margin: 0 0 10px; color: #777; font-size: 16px; }
        .card .number { font-size: 32px; font-weight: bold; color: var(--primary-color); }

        #report-content {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            min-height: 400px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        th, td {
            padding: 12px 15px;
            text-align: right;
            border-bottom: 1px solid #eee;
        }
        th {
            background-color: #f8f9fa;
            color: var(--primary-color);
            font-weight: bold;
        }
        tr:hover { background-color: #f1f1f1; }
        
        .print-header { display: none; text-align: center; margin-bottom: 20px; }
        .print-header h2 { margin: 0; color: var(--primary-color); }
        .status-msg { text-align: center; padding: 20px; color: #777; }

        @media print {
            .no-print { display: none !important; }
            .print-header { display: block; }
            body { background: white; }
            .container { max-width: 100%; margin: 0; padding: 0; }
            #report-content { box-shadow: none; }
        }
    </style>
</head>
<body>

    <header class="no-print">
        <a href="manage.html" class="back-btn"><i class="fas fa-arrow-right"></i> رجوع للإدارة</a>
        <h2>لوحة إحصائيات تفعيل الشهور</h2>
        <div style="width: 100px;"></div>
    </header>

    <div class="container">
        
        <div class="filters no-print">
            <div class="filter-group">
                <label>تاريخ التفعيل من:</label>
                <input type="date" id="startDate" onchange="filterAndRender()">
            </div>
            <div class="filter-group">
                <label>تاريخ التفعيل إلى:</label>
                <input type="date" id="endDate" onchange="filterAndRender()">
            </div>
            <div class="filter-group">
                <label>المدرس:</label>
                <select id="teacherSelect" onchange="filterAndRender()">
                    <option value="all">عرض الكل</option>
                </select>
            </div>
            <button class="action-btn" onclick="filterAndRender()">تحديث البيانات</button>
            <button class="action-btn pdf-btn" onclick="exportPDF()">
                <i class="fas fa-file-pdf"></i> حفظ PDF
            </button>
        </div>

        <div class="stats-cards no-print">
            <div class="card">
                <h3>إجمالي التفعيلات (في الفترة المحددة)</h3>
                <div class="number" id="totalActivations">0</div>
            </div>
            <div class="card">
                <h3>الطلاب الفريدين</h3>
                <div class="number" id="uniqueStudents">0</div>
            </div>
        </div>

        <div id="report-content">
            <div class="print-header">
                <h2>تقرير تفعيلات الشهور - AMG</h2>
                <p id="reportPeriodText"></p>
            </div>
            
            <table id="dataTable">
                <thead>
                    <tr>
                        <th width="5%">#</th>
                        <th width="25%">اسم الطالب</th>
                        <th width="20%">المدرس</th>
                        <th width="25%">الشهر المفعل</th>
                        <th width="25%">وقت التفعيل (المحسوب)</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                    <tr><td colspan="5" class="status-msg">جاري تحميل البيانات...</td></tr>
                </tbody>
            </table>
        </div>

    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>

    <script>
        // --- تهيئة Firebase ---
        const firebaseConfig = {
            apiKey: 'AIzaSyCdqYrVFspJ4rZwidfaPtc9PYpNlQQm09k',
            authDomain: 'amgg-81ac3.firebaseapp.com',
            databaseURL: 'https://amgg-81ac3-default-rtdb.firebaseio.com',
            projectId: 'amgg-81ac3',
            storageBucket: 'amgg-81ac3.firebasestorage.app',
            messagingSenderId: '284879336757',
            appId: '1:284879336757:web:1f42836c2382d11b73087c'
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const auth = firebase.auth();

        // متغيرات البيانات
        let rawUsers = {};
        let rawMonths = {};
        let rawAccess = {};
        let teacherNames = new Set();
        let monthMap = {}; 

        // الثوابت الحسابية: 30 يوماً
        const THIRTY_DAYS_MS = 30 * 24 * 60 * 60 * 1000;

        // التحقق من صلاحية الأدمن
        auth.onAuthStateChanged(user => {
            if (user) {
                db.ref(`admins/${user.uid}`).once('value', snap => {
                    if (snap.exists()) {
                        initPage();
                    } else {
                        alert('غير مصرح لك بالدخول');
                        window.location.href = 'index.html';
                    }
                });
            } else {
                window.location.href = 'index.html';
            }
        });

        // دالة البدء
        async function initPage() {
            setInitialDates();
            try {
                const [usersSnap, monthsSnap, accessSnap] = await Promise.all([
                    db.ref('users').once('value'),
                    db.ref('months').once('value'),
                    db.ref('student_month_access').once('value')
                ]);

                rawUsers = usersSnap.val() || {};
                rawMonths = monthsSnap.val() || {};
                rawAccess = accessSnap.val() || {};

                processMonthsData();
                populateTeacherFilter();
                filterAndRender(); 

            } catch (error) {
                console.error("Error loading data:", error);
                document.getElementById('tableBody').innerHTML = `<tr><td colspan="5" class="status-msg" style="color:red">خطأ: ${error.message}</td></tr>`;
            }
        }

        // تواريخ افتراضية (عام 2025)
        function setInitialDates() {
            document.getElementById('startDate').value = "2025-01-01";
            document.getElementById('endDate').value = "2025-12-31";
        }

        function processMonthsData() {
            for (const [teacher, monthsObj] of Object.entries(rawMonths)) {
                teacherNames.add(teacher);
                for (const [mId, mData] of Object.entries(monthsObj)) {
                    monthMap[mId] = {
                        teacher: teacher,
                        name: mData.name
                    };
                }
            }
        }

        function populateTeacherFilter() {
            const select = document.getElementById('teacherSelect');
            teacherNames.forEach(tName => {
                const opt = document.createElement('option');
                opt.value = tName;
                opt.textContent = tName;
                select.appendChild(opt);
            });
        }

        // دالة الحساب والفلترة
        function filterAndRender() {
            const tableBody = document.getElementById('tableBody');
            tableBody.innerHTML = ''; 

            const startVal = document.getElementById('startDate').value;
            const endVal = document.getElementById('endDate').value;
            const selectedTeacher = document.getElementById('teacherSelect').value;

            if (!startVal || !endVal) { 
                tableBody.innerHTML = '<tr><td colspan="5" class="status-msg">يرجى تحديد التواريخ</td></tr>';
                return; 
            }

            // تحويل دقيق: بداية اليوم الأول ونهاية اليوم الأخير
            const rangeStart = new Date(startVal + 'T00:00:00').getTime();
            const rangeEnd = new Date(endVal + 'T23:59:59').getTime();
            
            document.getElementById('reportPeriodText').innerText = `من ${startVal} إلى ${endVal}`;

            let count = 0;
            let rowsHTML = '';
            let uniqueStudentSet = new Set();
            let allRowsData = []; // للتخزين والترتيب

            // التكرار على السجلات
            for (const [userId, userVisits] of Object.entries(rawAccess)) {
                const userData = rawUsers[userId];
                const userName = userData ? userData.fullName : 'مستخدم محذوف';
                const userEmail = userData ? userData.email : userId;

                for (const [monthId, expiryTimestamp] of Object.entries(userVisits)) {
                    
                    // المعادلة: تاريخ التفعيل = تاريخ الانتهاء - 30 يوم
                    const activationTimestamp = expiryTimestamp - THIRTY_DAYS_MS;

                    // المقارنة الدقيقة
                    if (activationTimestamp >= rangeStart && activationTimestamp <= rangeEnd) {
                        
                        let teacherName = 'غير معروف';
                        let monthName = 'غير معروف';

                        if (monthMap[monthId]) {
                            teacherName = monthMap[monthId].teacher;
                            monthName = monthMap[monthId].name;
                        }

                        if (selectedTeacher !== 'all' && teacherName !== selectedTeacher) {
                            continue; 
                        }

                        allRowsData.push({
                            userName,
                            userEmail,
                            teacherName,
                            monthName,
                            activationTimestamp,
                            userId
                        });
                        
                        uniqueStudentSet.add(userId);
                    }
                }
            }

            // ترتيب البيانات حسب تاريخ التفعيل (الأحدث أولاً)
            allRowsData.sort((a, b) => b.activationTimestamp - a.activationTimestamp);

            // بناء الجدول
            allRowsData.forEach(row => {
                count++;
                const dateStr = new Date(row.activationTimestamp).toLocaleString('ar-EG', {
                    year: 'numeric', month: 'numeric', day: 'numeric',
                    hour: 'numeric', minute: 'numeric'
                });

                rowsHTML += `
                    <tr>
                        <td>${count}</td>
                        <td>
                            <strong>${row.userName}</strong><br>
                            <span style="font-size:12px; color:#777;">${row.userEmail}</span>
                        </td>
                        <td>${row.teacherName}</td>
                        <td>${row.monthName}</td>
                        <td style="direction:ltr; text-align:right;">${dateStr}</td>
                    </tr>
                `;
            });

            if (count === 0) {
                tableBody.innerHTML = '<tr><td colspan="5" class="status-msg">لا توجد عمليات تفعيل مطابقة لهذه الفترة</td></tr>';
            } else {
                tableBody.innerHTML = rowsHTML;
            }

            // تحديث البطاقات
            document.getElementById('totalActivations').textContent = count;
            document.getElementById('uniqueStudents').textContent = uniqueStudentSet.size;
        }

        // دالة PDF
        function exportPDF() {
            const element = document.getElementById('report-content');
            const printHeader = document.querySelector('.print-header');
            printHeader.style.display = 'block';
            const opt = {
                margin: 0.5,
                filename: `تقرير_التفعيل_${new Date().toISOString().slice(0,10)}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2 },
                jsPDF: { unit: 'in', format: 'a4', orientation: 'portrait' }
            };
            html2pdf().set(opt).from(element).save().then(() => {
                printHeader.style.display = 'none';
            });
        }
    </script>
</body>
</html>